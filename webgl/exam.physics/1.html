<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title> T300 App </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">

    <!--캐쉬제거-->
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Expires" content="-1">

    <script src="../libs/extra/jquery-2.0.3.min.js"></script>
    <script src="../libs/extra/async.js"></script>

    <script src='../libs/threejs/three.js'></script>
    <script src='../libs/threejs/js/controls/OrbitControls.js'></script>

    <script src="../libs/cannon/cannon.js"></script>

    <script src="../libs/elvis5/core.js"></script>
    <script src="../libs/elvis5/util.js"></script>
    <script src="../libs/elvis5/physics.js"></script>

</head>

<body style="margin: 0px;" >


<div id="container"></div>

<script>

    function AppicationMain() {

        var shot_obj = {

        };
        var raycaster = new THREE.Raycaster();
        var target1;



        this.Smgr = new ramb3d.scene.SceneManager({
            camera : {
                fov : 45,
                far : 1024,
                near : 1,
                position : new THREE.Vector3(0,2,-5),
                lookat : new THREE.Vector3(0,0,0)

            },
            renderer : {
                type : 'webgl',
                clear : {
                    color : 0x000000,
                    alpha : 1
                }
            },
            setup : function() {

                //초기화 코드는 여기에서 코딩한다.
                var context = this;

                var target_group = new THREE.Group();
                context.scene.add(target_group);
                context.target_group = target_group;
                context.scene.add(target_group)

                var bullet_group = new THREE.Group();
                bullet_group.name ='bullet_group';
                context.scene.add(bullet_group)
                context.bullet_group = bullet_group;

                var bullet_trace_group = new THREE.Group();
                bullet_group.name ='bullet_trace_group';
                context.scene.add(bullet_trace_group)
                context.bullet_trace_group = bullet_trace_group;

                async.waterfall([
                            function(next) {

                                var world = new CANNON.World();
                                world.gravity.set(0, -9.82, 0);
                                world.broadphase = new CANNON.NaiveBroadphase();
                                world.solver.iterations = 10;
                                context.world = world;


                                next();
                            },
                            function(next) {

                                //-------------------------------
                                //target 1

                                var dummy = new THREE.Group();

                                var matrial = new THREE.MeshBasicMaterial({color:0x00ff00,wireframe:true});
                                var geo = new THREE.CubeGeometry(1,1,0.2);
                                var node = new THREE.Mesh(geo,matrial);
                                dummy.mesh = node;
                                dummy.add(node);
                                target1 = dummy;
                                context.target_group.add(dummy);
                                //----------------------------------



                                next();
                            }

                        ],
                        function(err,result) {
                            console.log('setup complete');
                        });
                //-----------------

                //그리드헬퍼
                context.helper =  new THREE.GridHelper( 50, 1 ,0x00ff00,0xff0000);
                this.scene.add(context.helper);

                //총알물리 정의
                this.ballShape = new CANNON.Sphere(0.1);
                this.ballGeometry = new THREE.SphereGeometry(this.ballShape.radius, 8, 8);
                this.ballMaterial = new THREE.MeshBasicMaterial( { color: 0x00ff00, wireframe: true } );

                //오빗컨트롤
                //카메라의 현재 위치 기준으로 시작한다.
                var controls = new THREE.OrbitControls( this.camera );
                controls.target.set(0,0,0);// = new THREE.Vector3( 0, 0, 0 ); //바라보는 위치
                controls.update();

                //레이 캐스터
                this.raycaster = new THREE.Raycaster();

            },
            event : {
                onWindowResize : function() {
                    //동적으로 창의 크기가 바뀌면 이부분이 콜백된다.
                    this.updateAll({
                        resize : {
                            width :  window.innerWidth,
                            height : window.innerHeight
                        }
                    });
                },
                onUpdate : function(event) {

                    //TWEEN.update();

                    var context = this;
                    var bullets = context.bullet_group.children;

                    if(context.world) {
                        context.world.step(event.deltaTick);
                        //applyBodies(context.target_group.children);
                        esparty.elvis3d.physics.applyBodies(bullets);


                        for(var i=bullets.length-1;i >= 0;i--) {
                            //검사대상탄환
                            var bullet = bullets[i];

                            //생존시간 체크
                            bullet.workObj.life_acctime += event.deltaTick;
                            if (bullet.workObj.life_acctime > bullet.workObj.life_limit) {
                                context.bullet_group.remove(bullet)
                                context.world.removeBody(bullet.rdbody);

                            }
                            else {
                                var dist = bullet.position_old.distanceTo(bullet.position);
                                var dir = bullet.position_old.clone();
                                dir.sub(bullet.position).normalize();

                                raycaster.set(bullet.position,dir);
                                var intersects = raycaster.intersectObject(target1.mesh);

                                var material = this.ballMaterial;

                                if(intersects.length > 0) {

                                    //충돌했으면.
                                    if(intersects[0].distance < dist) {
                                        console.log(intersects[0]);
                                        material = new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe: true } );
                                    }
                                }

                                var ballMesh = new THREE.Mesh( this.ballGeometry,material  );
                                ballMesh.position.copy(bullet.position_old);
                                bullet.position_old.copy(bullet.position)

                                context.bullet_trace_group.add(ballMesh);

                                //context.scene.add(ballMesh)

                            }
                        }


                    }


                    this.updateAll();
                },
                onMouseDown : function(event) {
                    var mx = ( event.offsetX / this.window_size.width ) * 2 - 1;
                    var my = - ( event.offsetY / this.window_size.height ) * 2 + 1;

                    var vector = new THREE.Vector3( mx, my, 0.5 ).unproject( this.camera );
                    var dir = vector.clone();
                    dir.sub( this.camera.position ).normalize();

                },
                onMouseMove : function(event) {
                    var mx = ( event.offsetX / this.window_size.width ) * 2 - 1;
                    var my = - ( event.offsetY / this.window_size.height ) * 2 + 1;

                    var vector = new THREE.Vector3( mx, my, 0.5 ).unproject( this.camera );

                    var dir = vector.clone();

                    dir.sub( this.camera.position ).normalize();

                    shot_obj.start_pos = vector;
                    shot_obj.dir = dir;

                    //console.log(this.camera.position)

                },
                onKeyDown : function(event) {
                    //console.log(event);
                    if(event.code == 'KeyS') {

                        console.log(shot_obj)
                        var vector = shot_obj.dir;
                        var x = shot_obj.start_pos.x;
                        var y = shot_obj.start_pos.y;
                        var z = shot_obj.start_pos.z;

                        var ballBody = new CANNON.Body({
                            mass: 1,
                            position : new CANNON.Vec3(x,y,z), // m
                        });
                        ballBody.addShape(this.ballShape);
                        var ballMesh = new THREE.Mesh( this.ballGeometry, this.ballMaterial );
                        this.world.addBody(ballBody);
                        this.scene.add(ballMesh);
                        ballMesh.rdbody = ballBody;
                        var velocity = 80;
                        ballBody.velocity.set(vector.x * velocity,vector.y* velocity,vector.z* velocity);
                        ballMesh.position.set(x,y,z);
                        ballMesh.position_old = new THREE.Vector3(x,y,z)

                        //라이프 타임 계산용
                        ballMesh.workObj = {
                            life_limit : 0.5,
                            life_acctime : 0
                        }

                        this.bullet_group.add(ballMesh);

                    }
                    else if(event.code == 'KeyC') {
                        esparty.elvis3d.util.scene.removeAllChildren({node : this.bullet_trace_group});
                    }


                }
            }
        });
        //-----------
    }
    //---------------


    theApp = new AppicationMain();


</script>



</body>
</html>